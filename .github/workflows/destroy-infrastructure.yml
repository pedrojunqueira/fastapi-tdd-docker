name: ğŸ—‘ï¸ Destroy Azure Infrastructure

on:
  workflow_dispatch: # Manual trigger only - prevents accidental destruction
    inputs:
      confirmation:
        description: 'Type "DESTROY" to confirm infrastructure deletion'
        required: true
        type: string

env:
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

jobs:
  destroy:
    name: "ğŸ”¥ Destroy Azure Resources"
    runs-on: ubuntu-latest
    if: github.event.inputs.confirmation == 'DESTROY'
    environment: production
    permissions:
      contents: read
      id-token: write

    steps:
      - name: âš ï¸ Destruction Confirmation
        run: |
          echo "ğŸš¨ DESTRUCTIVE ACTION CONFIRMED"
          echo "This will permanently delete all Azure resources"
          echo "Environment: production"
          echo "Confirmation received: ${{ github.event.inputs.confirmation }}"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Azure Developer CLI (azd)
        run: |
          curl -fsSL https://aka.ms/install-azd.sh | bash
          echo "$HOME/.azd/bin" >> $GITHUB_PATH

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: List existing resources before destruction
        run: |
          echo "ğŸ“‹ Current Azure resources:"
          az group list --output table || echo "No resource groups found"

          echo "ğŸ” Looking for azd-created resources:"
          az group list --query "[?contains(name, 'rg-') || contains(name, 'production')]" --output table || echo "No matching resource groups found"

      - name: Destroy Infrastructure with azd
        run: |
          echo "ğŸ”§ Authenticating azd with service principal..."
          azd auth login --client-id "$AZURE_CLIENT_ID" --client-secret "$AZURE_CLIENT_SECRET" --tenant-id "$AZURE_TENANT_ID"

          echo "ğŸŒ Setting up production environment..."
          azd env select production || azd env new production

          echo "ğŸ“ Setting Azure location..."
          azd env set AZURE_LOCATION australiaeast

          echo "ğŸ—‘ï¸ Starting infrastructure destruction..."
          azd down --force --purge

          echo "âœ… azd destruction completed"
        env:
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_ENV_NAME: production
          AZURE_APP_NAME: fastapi-tdd-docker

      - name: Verify resource cleanup
        run: |
          echo "ğŸ” Verifying resource cleanup..."

          echo "Remaining resource groups:"
          az group list --output table || echo "No resource groups found"

          echo "Checking for any remaining azd resources:"
          REMAINING=$(az group list --query "[?contains(name, 'rg-') || contains(name, 'production')]" --output tsv | wc -l)

          if [ "$REMAINING" -eq 0 ]; then
            echo "âœ… All azd resources successfully removed"
          else
            echo "âš ï¸ Some resources may still exist:"
            az group list --query "[?contains(name, 'rg-') || contains(name, 'production')]" --output table
            echo "ğŸ’¡ You may need to manually delete remaining resources in the Azure Portal"
          fi

      - name: ğŸ‰ Destruction Summary
        run: |
          echo "## ğŸ—‘ï¸ Infrastructure Destruction Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Actions Performed:" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”§ Authenticated with Azure using service principal" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ Selected production environment" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ—‘ï¸ Executed \`azd down --force --purge\`" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” Verified resource cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ’° Cost Impact:" >> $GITHUB_STEP_SUMMARY
          echo "- All Azure resources have been destroyed" >> $GITHUB_STEP_SUMMARY
          echo "- No further charges should be incurred" >> $GITHUB_STEP_SUMMARY
          echo "- Verify in [Azure Cost Management](https://portal.azure.com/#view/Microsoft_Azure_CostManagement/Menu/~/overview)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ§¹ Optional Cleanup:" >> $GITHUB_STEP_SUMMARY
          echo "Consider removing GitHub secrets if no longer needed:" >> $GITHUB_STEP_SUMMARY
          echo "- \`AZURE_CLIENT_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`AZURE_CLIENT_SECRET\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`AZURE_TENANT_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`AZURE_SUBSCRIPTION_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸŠ Infrastructure cleanup successful!**" >> $GITHUB_STEP_SUMMARY

  # Safety job that runs if wrong confirmation is provided
  safety-check:
    name: "ğŸ›¡ï¸ Safety Check"
    runs-on: ubuntu-latest
    if: github.event.inputs.confirmation != 'DESTROY'

    steps:
      - name: âŒ Incorrect Confirmation
        run: |
          echo "ğŸ›¡ï¸ SAFETY CHECK ACTIVATED"
          echo "âŒ Destruction cancelled - incorrect confirmation provided"
          echo "ğŸ“ You entered: '${{ github.event.inputs.confirmation }}'"
          echo "âœ… Required: 'DESTROY'"
          echo ""
          echo "ğŸ’¡ To destroy infrastructure, re-run this workflow and type exactly: DESTROY"
          echo "âš ï¸ This is a safety measure to prevent accidental resource deletion"
          exit 1
