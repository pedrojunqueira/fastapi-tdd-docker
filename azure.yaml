# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: fastapi-tdd-docker
metadata:
  template: fastapi-tdd-docker@0.0.1-beta
services:
  web:
    project: ./project
    language: python
    host: containerapp
    docker:
      path: ./Dockerfile.prod
  frontend:
    project: ./frontend
    language: js
    host: containerapp
    docker:
      path: ./Dockerfile.azure
      buildArgs:
        - VITE_AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
        - VITE_AZURE_TENANT_ID=${AZURE_TENANT_ID}
        - VITE_API_CLIENT_ID=${AZURE_API_CLIENT_ID}
        - VITE_REDIRECT_URI=${FRONTEND_URI}
        - VITE_API_BASE_URL=${WEB_URI}
hooks:
  preprovision:
    shell: sh
    run: |
      echo "Validating required environment variables..."
      missing_vars=""
      if [ -z "$AZURE_TENANT_ID" ]; then
        missing_vars="$missing_vars AZURE_TENANT_ID"
      fi
      if [ -z "$AZURE_API_CLIENT_ID" ]; then
        missing_vars="$missing_vars AZURE_API_CLIENT_ID"
      fi
      if [ -z "$AZURE_CLIENT_ID" ]; then
        missing_vars="$missing_vars AZURE_CLIENT_ID"
      fi
      if [ -n "$missing_vars" ]; then
        echo "ERROR: The following required environment variables are not set:$missing_vars"
        echo ""
        echo "Please set them using:"
        for var in $missing_vars; do
          echo "  azd env set $var <value>"
        done
        exit 1
      fi
      echo "All required environment variables are set."
  postprovision:
    shell: sh
    run: |
      echo "Infrastructure provisioned successfully"
      echo "FRONTEND_URI: $FRONTEND_URI"
      echo "WEB_URI: $WEB_URI"

      # Ensure URIs are available before redeploying frontend
      if [ -z "$FRONTEND_URI" ] || [ -z "$WEB_URI" ]; then
        echo "WARNING: FRONTEND_URI or WEB_URI not set. Fetching from azd outputs..."
        export FRONTEND_URI=$(azd show --output json | jq -r '.services.frontend.endpoint // empty')
        export WEB_URI=$(azd show --output json | jq -r '.services.web.endpoint // empty')
        
        # Also save to azd env for future deploys
        azd env set FRONTEND_URI "$FRONTEND_URI"
        azd env set WEB_URI "$WEB_URI"
        
        echo "Fetched and saved FRONTEND_URI: $FRONTEND_URI"
        echo "Fetched and saved WEB_URI: $WEB_URI"
      fi

      if [ -n "$FRONTEND_URI" ] && [ -n "$WEB_URI" ]; then
        echo "Redeploying frontend with updated URLs..."
        FRONTEND_URI="$FRONTEND_URI" WEB_URI="$WEB_URI" azd deploy frontend --no-prompt
      else
        echo "ERROR: Could not determine FRONTEND_URI or WEB_URI. Skipping frontend redeploy."
        exit 1
      fi
  predeploy:
    shell: sh
    run: |
      echo "Running pre-deployment checks..."
      echo "Building and pushing container images..."
