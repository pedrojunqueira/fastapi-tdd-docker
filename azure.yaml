# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: fastapi-tdd-docker
metadata:
  template: fastapi-tdd-docker@0.0.1-beta
services:
  web:
    project: ./project
    language: python
    host: containerapp
    docker:
      path: ./Dockerfile.prod
  frontend:
    project: ./frontend
    language: js
    host: containerapp
    docker:
      path: ./Dockerfile.azure
      buildArgs:
        - VITE_AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
        - VITE_AZURE_TENANT_ID=${AZURE_TENANT_ID}
        - VITE_API_CLIENT_ID=${AZURE_API_CLIENT_ID}
        - VITE_REDIRECT_URI=${FRONTEND_URI}
        - VITE_API_BASE_URL=${WEB_URI}
hooks:
  postprovision:
    shell: sh
    run: |
      echo "Infrastructure provisioned successfully"
      echo "Redeploying frontend with updated URLs..."
      azd deploy frontend --no-prompt
  predeploy:
    shell: sh
    run: |
      echo "Running pre-deployment checks..."
      echo "Building and pushing container images..."
